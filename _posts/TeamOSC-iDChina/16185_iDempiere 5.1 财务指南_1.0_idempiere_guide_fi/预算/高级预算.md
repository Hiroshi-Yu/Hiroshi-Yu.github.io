高级预算
===

![高级预算](http://static.oschina.net/uploads/space/2016/0506/014147_T24Y_2720480.png)

插件安装
---

1. 访问https://sourceforge.net/projects/red1/files/p2/Budget/
2. 下载org.idempiere.budget_版本.最新日期.jar，通过osgi控制台安装并启动。
3. 详细操作可参考[高级预算手册](https://sourceforge.net/projects/red1/files/p2/Budget/Budget.pdf/download)。

概述
---

高级预算模块可以提供：
- 趋势定义
- 基于单据控制
- 基于凭证控制
- 基于维度的预算控制
- 基于比例的预算方案
- 销售端预测
- 基于产品数量
- 预算追溯

预算流程
---

预算控制针对采购相关单据（订单、发票、付款）和凭证单据，销售合同也可以用来做预算（那叫预测forecast）。
整个流程为：
- 设置预算配置。
- 设置预算计划，定义规则。
- 导入预算数据（略）
- 预算报告（略）

![预算菜单](http://static.oschina.net/uploads/space/2016/0503/220737_Womj_2720480.png)

![预算配置](http://static.oschina.net/uploads/space/2016/0505/211010_g9rm_2720480.png)

![预算规则1](http://static.oschina.net/uploads/space/2016/0505/211103_yAzx_2720480.png)

预算参数
---

1. 历来年数Forecast years: 0=当年，1=去年，以此类推。不超过99年。
2. 某年数据Forecast for this year: 指定某年历史数据。
3. 按比例Pro-rata: 基于历史数据汇总的比例平均，如果选中，按同期月份（Month on Month）不显示。
4. 按同期月份Month on Month: 与去年同期月份比较，不选择将“按比例”生效。
5. 预算趋势Formula Trend: 平均Average/翻番Progression/
6. 历来月数Forecast months：1=上月，以此类推。
7. 某月数据Forecast for this month：指定某月历史数据。

![预算规则2](http://static.oschina.net/uploads/space/2016/0501/034737_P97h_2720480.png)

> 16100资产科目+4100利润科目=2080，再*1.2 = 2496， 再乘以39.66%百分比，得到预算目标=990，作为该科目的预算规则。


预算编制
---

企业或者内部组织对外提供产品或者服务，所发生的成本都可归为“直接成本”和“间接成本”。
基于此划分，预算规则可理解为限定于某个期间，相互组合的预算维度对两类成本的控制。
常见的预算规则有：
1. 作业类
  - 采购(间接成本)：供应商维护预算、采购资金预算、采购员薪资预算。
  - 制造(间接成本)：材料成本预算、材料间接费用预算、外协预算、资产预算、员工薪资预算、制造间接费用预算。
  - 销售(直接成本)：佣金预算、招待费预算、销售费用预算、销售员薪资预算。
  - 管理(间接成本)：财务投资预算、办公费用预算、管理人员薪资预算。

2. 项目类（工程、研发、订单等）
  - 直接成本：项目材料预算、项目人工薪资预算、项目间接支出预算。
  - 间接成本：财务费用预算、销售费用预算、项目管理费用预算。

3. 市场活动类（新品促销、季度推广等）
  - 直接成本：活动材料预算、活动人工薪资预算、活动间接支出预算。
  - 间接成本：财务费用预算、销售费用预算、活动管理费用预算。

![预算规则逻辑](http://static.oschina.net/uploads/space/2016/0430/203709_dJoI_2720480.png)

规则逻辑
---

预算规则对采购单据或者总账凭证的维度进行判断是否控制。总账凭证还可以依据科目，采购单据还可以依据产品数量。
####条件优先级####
1. 指定条件：项目，作业，市场活动。如果只选一个，则规则结果为：项目A+所有作业+所有市场活动
2. 非指定条件：商业伙伴，期间。如果设置该维度，则规则结果为“商业伙伴A的（项目A+所有作业+所有市场活动）”
3. 非指定条件2：产品或者数量值。和条件2类似。

条件1,2,3相当于上图的HOW，WHO，WHAT。

####多规则匹配例外####
当某个单据或者凭证，匹配到多个规则，最终的判断结果还须遵从如下要求：
1. 如果后续规则包含期间定义，则该条规则的期间无效。
2. 如果后续规则包含组织定义，则该条规则的组织无效。
3. 如果多条规则包含合作伙伴定义，则除第一条外的其他规则的合作伙伴无效。

假设：
1. 员工A + 项目A                        （金额<200）
2. 组织A + 项目A                        （金额<1000）

如果“员工A”正好属于“组织A”，则规则1有效，但系统将会提示规则冲突。

####产品匹配例外####
记住所有的预算都是针对成本控制的，产品（直接成本）作为匹配对象也容易导致冲突。比如：
某个单据包含多个产品，当某个规则匹配到某个产品，系统不会再继续执行明细行的其他产品规则（也就是说只能有一个产品会匹配）。
你可以使用单据表头的项目、市场活动等其他维度。 

> ###最佳原则
> 请参考以下原则：
> 1. 只使用商业伙伴，其他条件为空。
> 2. 只使用组织，其他条件为空。
> 3. 只使用期间，其他条件为空。
> 4. 只使用作业，或者项目，或者市场活动，或者3者的唯一组合。
> 5. 任何第4种+前3种的组合，但前3种维度不能有隶属关系（比如商业伙伴“员工A”不能属于“组织”）。

![需要测试如下规则的执行](http://static.oschina.net/uploads/space/2016/0501/024911_v70J_2720480.png)

总账控制
---

单据控制的账户通过采购订单、采购发票、采购付款来控制。总账控制规则则可以使用所有非单据类账户。
规则中，账户科目是必填项，且需要指定科目的借贷方向。如果是借方，规则将累加借方来判断。如果是贷方，规则将累加借方来判断。
规则是基于对每条分录的判断，而不是整个凭证。

规则案例1
---

1. 规则：按利润比例设置采购预算。
2. 新建采购订单，金额超过预算。
3. 修改预算规则。
4. 新建连续的供应商发票。
5. 检查结果。

规则案例2
---

1. 规则1：按年固定利润，每月平均预算
2. 规则2：产品A+市场活动A的预算是50%的固定利润/月。
3. 新建发票，检查结果。

规则案例3
---

1. 规则1：按账户余额基数设置预算
2. 新建发票，检查结果。

预算报表
---

有时间再写，反正维度都有。

MORE
---

http://club.kisdee.com/forum.php?mod=viewthread&tid=996124&extra=page%3D1

