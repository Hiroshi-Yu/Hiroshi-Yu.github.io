会计规则
===

概述
---

iDempiere系统定义：
1. 用户每次只能登录一个实体。
2. 一个实体可以创建多个组织，多个帐套，多个日历。
2. 一个实体会被指定使用一个默认账套，一个默认日历。
3. 每个组织可以指定不同的账套（账套->组织）。每个账套可以指定不同的科目表（维度->科目）
4. 每个组织可以指定不同的日历（组织->组织信息），报表维度集（Report cube）可以按日历出报表。
5. 一个实体存在多个账套，无论你登录到哪个组织发生业务，系统都会按每个账套规则登帐。

> ###重启，重启，重启
> 账套设置需要重启会计引擎，新增多个账套，需要重启服务器程序。

账套/账簿
---

通常所说的账套，是基于会计规则所记录的所有财务数据信息。id没有明确的账套/账簿概念，以下所说可能泛指”财务数据“或者”会计模式“。
id的所有财务账套数据，所有年度的分录数据都是存储在同一个数据库和物理表内。用户只需登录到不同的实体，选择不同的”会计模式（账套）“并可无缝查询需要的数据。

账套分类：
1、法规账套：不同会计准则账套。
2、法人账套：不同法人组织的对外/对内核算账套
3、核算账套：不同事业部或者业务线的对内核算账套
4、财务账套：预算、承诺、发生等不同业务性质的统计账套

账套（会计模式）通常由如下确定：
会计规则：法律法规，方法，惯例（肯定包含了）
科目表：自然账户分类
币种：记账币种
日历：会计日历
另外如下两点，可能被包含在上述的会计规则之中。
记账方式：权责发生制、收付实现制、承诺会计
成本计价方式：计划成本、实际成本

其中最关键的是会计规则，即企业发生的一笔业务，能否在2个不同会计规则下生成不同的会计分录？
从两个方面来看：
1、哪些业务事件会产生会计分录？ID的会计模式中已经定义了默认科目与实际业务账户的映射关系。
2、这些业务事件的分录如何计入？系统最基础、最复杂也是最抽象的过程，包括了复杂的用户预定义工作，诸如会计事件分类（Event Class）与会计事件类型（Event Type）组合定义、日记账行定义、日记账行类型定义等等。ID的记账规则由内部记账规则引擎完成，只能通过使用修改代码的方式来进行拓展。

并行记账系统通常存在转换差异、信息丢失、无法审计、结果延时等挑战，ID财务的“多会计规则”功能毫无此类问题，并带给用户如下好处：
1. 信息源唯一，无需重复
2. 会计规则互不干扰，且可随时增加或者停用。
3. 可以对历史、未来事务进行登帐。
4. 事务信息可以修改，并可选重新登帐。
5. 会计规则信息，维护简单
6. 会计容错性好

> ###单账套/多账套
> 使用单账套还是多账套？
> 1、会计规则是否一致
> 2、科目是否一致
> 3、会计日历是否一致
> 4、外币是否多种？
> 5、数据统计/财务核算是否多种?
> 6、财务数据权限是否隔离？
> 如果存在以上问题，即需要设置多账套并行记账。
> 
> 借用Oralce EBS的解释：
> ”EBS系统所谓“多账簿”功能与“多帐套（分类帐）接入”功能是两个不同的概念。“多账簿”功能表示“一个用户的同一业务处理，系统自动生成多本帐”，反映的是系统业务处理功能，R12具备，而R11不完全具备（R11仅能提供多币种报表）。“多帐套（分类帐）接入”功能表示“一个用户如何接入多个帐套（分类帐）”的权限管理方式（“上下文”环境切换方式），R11也具备，但对于同一用户，必须通过在具有相同业务功能的不同责任间切换才能实现，使用时不是太方便，而R12的同一用户，无需进行“责任”切换，仅通过在表单上直接选择切换就能实现，使用比较方便。R12与R11的上下文切换方式虽然不同，但切换后的系统业务处理功能则基本相同。“
> 
> 从功能上讲，ID与EBS R11功能类似，但能达到”自动生成多本帐功能“。（注：简单分录业务）
> ID在账套接入上，可以实现直接选择表单组织来完成某些业务功能，无需上下文切换。
> 
> ID登录时的上下文环境切换（登陆实体/角色，登录组织，登录仓库，登录日期），系统原意：
> 客户/角色：数据屏蔽，权限安全相关，比不可少。
> 组织/仓库/日期：方便填写单据的默认值，Default Org, Default Warehouse, Default Date。
> 
> 注：ID的登录组织只是一个默认组织，并非是一个限制，组织访问的权限限制依靠登录的角色来定。

多账套实例1
---

场景：企业法人A，需要2个记账模式：财务记账（本币）+法规记账（外币）
方案：
1. 新建实体，修改默认记账模式（本币+自定义记账科目）。
2. 该实体设置界面已经首选了第一个记账模式。
3. 在记账模式中新建第二条记录，设置外币（还可以指定到某个组织），自定义记账科目。
4. 无论你使用哪个组织登录，系统将使用”实体设置“的首选记账模式来记账。
5. 系统会根据第二个记账模式，相同业务同时生成不同的记账分录。
注：对于业务上需要使用外币，请选择相应外币的价格表或者在单据上选择。首选记账模式确定了单据的首选币种。

多账套实例2
---

场景：实体（总部，默认账套），组织1（子公司，法人账套），组织2（办事处，无账套）
需求：总部能出2个组织的财务报表，组织1能出财务报表，组织2只需完成单据。
方案：【待验证】
1. 实体账套不会分配给总部（only organization），供实体下其他组织产生分录。
2. 组织1账套分配给子公司组织（only organization），仅当登录到该组织产生相应分录。
3. 组织2，无需新建账套，默认使用总部账套。

> ###实体的账套设置
> 实体设置界面有一个选项：首选会计模式。
> 当该选项为某个会计模式时，该会计模式的设置界面”仅供组织使用Only Organization“选项必须为空。<注：这个好理解，如果实体的会计模式属于了某一个组织，那其他组织的业务分录就没地方去了。>
> 或者说，当你使用多个会计模式时，only org选项才可以选择某个模式记录，且不能与实体的首选模式相同。<注：只有多会计模式时，组织才可以单独分配一个会计模式用，其他组织用实体的首选模式，当然不能相同，相同就不是多模式了>
> <注：实体的首选会计模式，供该实体的所有组织产生分录，无法分配给具体的组织，多模式下可以更改>
> https://groups.google.com/d/topic/idempiere/D6AYZGUtvks/discussion

账户结构
---

ID的会计账户使用会计维度来标记，包括：
1. 组织 org
2. 事务组织 trx org
3. 科目 element
4. 子科目 sub element
5. 商业伙伴 BP
6. 产品
7. 项目
8. 工序活动
9. 市场活动
10. 销售区域
11. 来源地点
12. 目的地点
13. 自定义科目1：用户可以定义账户元素作为新维度（科目表是一种账户元素，你可以新建其他的账户元素）
14. 自定义科目2
15. 自定义维度1：用户可以定义任何表的列作为新维度
16. 自定义维度2

参考：http://wiki.adempiere.net/Setup_Custom_Account_Combination_using_User_List

通过以上维度的按需组合形成的账户，当企业事务发生后，并可用来登记原始单据所产生的财务数据。通常，一个最基本的的科目结构通常由“平衡段（后注）”-“科目段”组成。此2项属于必填项。

比如：
集团公司/法人公司会使用其中一个组织，并通常会指定为平衡段，标识为该公司的账户数据。
企业事务的其他组织信息，比如：事务组织（用于核算），通常设置为”事务组织“，可选为必填项。
往来单位通常使用bp维度，内部子公司之间的交易，也需要使用bp。

典型集团公司账户：组织（+集团公司）-科目-BP-产品-事务组织（各子公司）
典型子公司账户：组织（+财务子公司）-科目-BP-产品-事务组织(各部门)

因为集团子公司的组织路线是长短不齐的，账户的第一个组织维度只表明发生组织，标记其后科目的归属。
关于账户合并关系，可以通过报表层次树的组织树来实现。

![维度的平衡段](https://static.oschina.net/uploads/space/2017/0412/140121_bmXs_2720480.png)

> ###关于平衡段
> Oracle EBS解释：
> “平衡段”，表示在“公司段”层面，其日记账（Journals“会计分录”）的“借项等于贷项”，总是平衡的。其值集包括法律实体及基于公司管理需要而设定的运营实体；
> 
> 通俗的解释，通过平衡段来区别一个独立的核算实体，在这个平衡段下，资产=负债+所有者权益，跨平衡段帐务处理被视为公司间往来。
> 
> 体现国家法律法规要求的“会计科目”成为其中必不可少的一个组成段即“自然账户”段，自然账户所使用的值集，即为通常所说的“科目表”。系统在自然账户之上附加“公司、部门”等多个段信息，大大方便了在公司内及公司间的会计数据的统计分析工作。<以上解释来自starbhhc，纵横四海>
> 
> 其中，集团公司账户可以按需要分配多个平衡段，体现一个法人，多个经营实体的段值标记。
> 
> 从“法规遵从性”或“合规性”上讲，按照法人公司名称设定组织，并在账户中分配平衡段值为该组织，可以在财务报表中体现其正式性。
> 
> ID的平衡段概念
> 如果组织维度为Balanced属性（默认选中），实体内不同组织间的事务，将额外产生2条分录，分别计入各组织的”Intercompany Due From“和”Intercompany Due To“科目。
> 
> 由于组织具有单独财务核算性质，如果用户需要组织内记录资金往来，即可选择该属性。如果小公司组织架构无此要求，可禁止该选项以减少分录数量。

> ###维度的组织指定
> 问题：在账户维度中，指定第一个维度为一个具体组织，有什么作用？
> 2017-4-11 理解，没有用。
> 如果使用单据控制类的默认账户，组织维度会从单据中获取组织信息（表示发生组织）
> 如果使用手工凭证，选择账户组合时，该维度可以指定任意组织而得到你想要的账户。

账户组合
---

ID中，各维度信息形成的账户叫”账户组合Account Combination“，比如HQ-51300-_-_-_-_。

新建实体后，ID会根据初始化界面的维度信息，科目表的默认账户信息，新建相应的账户组合记录，供会计规则的默认科目设置使用。默认账户组合的会使用 \*组织+科目+其他维度样式，比如\*-REALIZEDGAIN-_-_-_-_表示所有组织的RealizedGain（已实现盈利）科目。

当指定了平衡段，加上具体科目，就可以用来设置各事务活动的分录归属。后面4段留空，会从原始单据的相关字段中提取，最后形成一个完整的具体账户。

账户组合用于：
1. 手工输入凭证。预先设置账户组合，可以方便用户记忆账户，快速输入手工凭证明细。凭证明细中可以直接选择有别名的”账户组合“，如果账户组合信息足够，选择后凭证明细会自动填入所有的维度信息。另，个人只能选择自己的”账户组合“。
2. 会计规则界面设置缺省科目。在账户组合窗口，用户可以随时新增账户记录。但在缺省科目上，维度信息就通常只包括组织和科目维度，其他维度会在业务单据中填入。

虽然在凭证（日记账）明细中能看到账户组合，但是在分录明细中无此字段。当然后续管理员可以加入该字段以方便人工阅读。

用于新建账户组合的科目必须满足：
1. 非汇总科目。
2. 非单据控制科目。

==新建账户组合==
1. 位置：【账户组合】窗口，新建。（需修改该窗口类型为”维护“）
2. 位置：【账户】对话框，新建
可以对账户组合创建容易识别的别名，依用户需求而定。

注意：账户组合因为具有多个维度字段，可能会存在重复账户。新建账户前最好查询是否可用，以免造成账户冗余。账户只能失效，无法删除。

根据每个分录的账户组合，统计汇总每个账套的维度信息，对于计算机来说，那就是太简单了。

科目更新并同步账户组合

```
编辑科目时，系统同时更新账户组合值

导入科目无法自动更新账户组合的描述和名称
select a.Combination ,a.Description, b.value, b.name, strpos(a.Combination, b.value)  from C_ValidCombination a
join C_ElementValue b on a.Account_ID = C_ElementValue_ID where strpos(a.Combination, b.value) = 0

导入科目后更新账户组合（需根据自己维度更改字符串）
update C_ValidCombination a 
set Combination= '*-' || b.value || '-_-_-_' , description =  '*-' || b.name || '-_-_-_' from 
 C_ElementValue b where a.Account_ID = b.C_ElementValue_ID and strpos(a.Combination, b.value) = 0

更新事务表的科目id
update Fact_Acct set Account_ID =1001058  where Account_ID = 1000493;
update Fact_Acct_Summary set Account_ID =1001058  where Account_ID = 1000493;
update Fact_Reconciliation set fact_acct_id =1001058  where fact_acct_id = 1000493;
update GL_JournalLine set Account_ID =1001058  where Account_ID = 1000493;
update GL_JournalLine set c_validcombination_id =1000555  where c_validcombination_id = 1000551;
```

重新登帐
---

单据完成后，手动或者自动过账，系统将产生相应的会计分录。当发现分录不对（科目不对，维度不对等等），则需要更改会计规则，然后重新对单据登帐。此时：
1. 系统删除原单据的所有分录
2. 载入新的会计规则
3. 重新生成新分录
更改会计规则，需要重启服务器才能生效。

几个选项
---

0. Automatic Period Control：自动期间开关（取系统时间，设置过账历史事件和过账未来时间）
1. Explicit Cost Adjustment：显示成本调整（参考其他小节）
2. Post Trade Discount：产生交易折扣分录（参考其他小节）
3. Post if Clearing Equal：过账清算账户，是否产生清算过渡分录。
4. Use Account Alias：使用账户别名
5. Allow Negative Posting：允许负数分录

第3选项关键点：
当清算账户与最终账户相同时，是否允许系统生成清算分录。如果选择，则生成分录。如果不选择，则不生成分录。如果用户不喜欢使用清算账户以减少分录条数，可以将清算账户与最终账户设置为同一科目，比如：
未分配付款=应收账款，
付款选择=应付账款，
在途资金=银行资产，
未开票收货=存货暂估，
采购价差=采购价差调整。
同时不选择该选项，即可不生成清算账户分录。

如果选择该选项，实际分录如下：
NO    Window                Document        Dr/Cr          Description                            Value
1        Material Receipt   MM Receipt     Dr               Product Asset                         380
2                                                                   Cr          Not invoiced receipts                  380
3        Matched Invoices                          Dr               Not invoiced receipts             380
4                                                                    Cr        《Product Inventory Clearing》         380
5        Invoice (Vendor)   AP Invoice        Dr             《 Product Inventory Clearing》    380
6                                                                    Cr          Account Payable Trade               380

如果不选择该选项，且设置产品的默认账户：结算账户=未到账户，第4+5条结算分录将不会记账。如下：
NO    Window                Document        Dr/Cr          Description                            Value
1        Material Receipt   MM Receipt     Dr               Product Asset                         380
2                                                                   Cr          Not invoiced receipts                  380
3        Invoice (Vendor)   AP Invoice        Dr               Not invoiced receipts             380
4                                                                    Cr          Account Payable Trade               380


新建账套
---

现在的账套维护功能还是很弱，只有一个“同科目表”账套的账户复制功能，如果新建一个账套使用不同的科目表，默认账户的设置还是很麻烦的。

希望有的功能：
1. 可以拷贝账套（连带拷贝维度，科目元素，科目值，科目树，账户组合，默认账户，各维度的默认账户）

