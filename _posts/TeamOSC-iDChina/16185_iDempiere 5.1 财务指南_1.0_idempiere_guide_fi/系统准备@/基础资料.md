基础资料
===

概述
---

基础资料的正确设计和输入是建立财务账套的前提。
基础资料分为：
1. 企业主数据：实体、组织、用户/角色、业务伙伴、仓库、产品、价格表
2. 财务资料：会计规则、科目、日历、税种、币种、总账类别、单据类型和流水号、费用

实体组织
---

参考：iDempiere 3.1 管理指南 - 【基础资料】
http://idempiere_guide_sm.mydoc.io/?t=186550

银行
---

银行与组织（经营实体）相关联。特别的，银行的设置在组织菜单下，而不是在财务菜单下。
ID的银行功能可以理解为“提供支付功能的账户”，因此它可以是服务组织的商业机构，也可以是内部银行，甚至是出纳的小钱柜，以前的id版本，它和现金簿的功能是一起的。经常往来的业务伙伴银行账户也可以在银行界面中维护。

系统默认没有建立银行记录，但是开票（待再次确认）、付款事务开始需要银行账户信息。

银行，下设多个银行账户，且具有组织属性。

单个账户可以属于多个组织，但属于*组织的账户无法使用（系统过账报错，组织/外币无银行账户记录），如账户被多组织使用，必须分别建立记录，其账户余额单独计算。（2017-4-16测试）

一个有意思的场景：
1. 一个公司
2. 二个不同的部门，业务基本相同，但物理地址不在一起，都使用同一个银行账户处理业务。
3. 需求：2个部门都能使用该银行来出来业务，且业务数据相互独立，分开核算。
4. 方案：组织架构=总部，组织1，组织2；使用组织12来完成日常业务和开票，使用总部来完成付款和银行对账所有相关事宜。（待验证）

用户-角色
---

实体初始化后，会自带4个用户：
实体用户：实体管理员，实体操作员，这2个用户可以修改。
系统用户：系统管理员（system），超级管理员（SuperUser），很显然，这2个用户是只读的。
具体参考：
iDempiere 3.1 管理指南 - 【权限】http://idempiere_guide_sm.mydoc.io/?t=186541

业务伙伴
---

业务伙伴是与企业发生事务的所有相对方。
实体初始化后，会自带3个合作伙伴：默认BP，实体管理员，实体操作员。

问题1：如何设置业务伙伴模板？
在【实体】-【实体信息】的『业务伙伴模板』字段，设置业务伙伴模板。

问题2：如何导入业务伙伴？
参考：【数据导入】http://idempiere_guide_sm.mydoc.io/?t=134387

问题3：如何设置业务伙伴的期初余额
导入单据信息（未清发票、未分配付款）进行初始化。

问题4：如何设置内部组织（子公司）为业务伙伴？
组织也可以是一个业务伙伴，特别是组织间发生交易时。
通过将BP链接到一个组织来完成BP和组织的映射，也可以在不需要的时候解链。
注意，一个BP只能链接到一个组织，只有非雇员业务伙伴才可以链接到组织。
如果根据业务伙伴新建组织，重新登陆后看到新组织（同时也并新建了该组织的仓库和库位）
参考：BPartnerOrgLink.doIt  (org.adempiere.base.process\src\org\compiere\process)

解链业务伙伴的组织，仅更新BP的链接组织为空（仓库无变动）
参考：BPartnerOrgUnLink.doIt (org.adempiere.base.process\src\org\compiere\process)

子公司间交易，会自动创建反向单据，比如A采购B,自动生成B销售A。
参考：[反向单据应用](http://idempiere_guide_fi.mydoc.io/?t=178385#widget_6392741)

问题5：如何按部门来隔离业务伙伴访问权限？
业务伙伴属于主数据，属于某个组织共享，其他组织（公司级别）是无法访问。
部门属于组织内部的职能组织（成本中心），可以通过角色来定义其他部门的只读模式。
更多数据权限，可以参考：【数据权限】http://idempiere_guide_sm.mydoc.io/?t=186541

问题6：业务伙伴能否属于多个子公司组织？
实际中，一个业务伙伴对应集团多个子公司。
如果业务伙伴主数据定位于组织层（子公司），则同一业务伙伴需按各子公司组织分别创建。
如果业务伙伴主数据定位于实体层（集团），则同一业务伙伴只需创建一次。

问题7：业务伙伴能否设置多个业务位置（或者地址）？
可以，一个业务伙伴可以拥有多个Location（位置或者地址）。
但是不同位置均共用业务伙伴的邮件模板、催款模板、格式定义等。
从财务角度，交易是针对业务伙伴（而不是业务位置），账户和模板都是在业务伙伴中定义。

问题8：id系统用户和业务伙伴的联系人是什么关系？
二者数据存储相同，但是用途稍有差异，id的用户不一定是业务伙伴的联系人。
初始化后，业务伙伴（职员，实体管理员）的联系人是自己（实体管理员），实体操作员同理。
默认业务伙伴（标准数据）没有联系人，新建联系人并分配合适的角色，该联系人也可以通过账户和密码登录id系统。
联系人比用户多了额外的业务伙伴权限控制。比如：
【联系人】-『完整的业务伙伴访问』：勾选此项，该用户拥有所有“请求系统+业务单据+文件下载”权限。
【联系人】-【业务伙伴权限】：可分别设置“请求系统“，”业务单据“，”文件下载“不同的权限。

问题9：业务伙伴的银行账号能否与业务位置关联？
默认银行账号与BP关联，无法与业务位置关联，可以通过设置AD相关规则实现。

问题10：如何使用百度地图定位业务伙伴地址
设置系统参数：LOCATION_MAPS_URL_PREFIX = http://map.baidu.com/?l=&s=s%26wd%3d

问题11：业务伙伴伙伴之间的代理关系如何设置？（BUG中）
【业务伙伴】-【业务伙伴规则】-【伙伴关系】定义2个BP之间的代理关系。
比如，将个人的财务地址（源BP）交由公司的财务地址（代理BP）来代理。
单据输入时，选择业务伙伴（源BP），其财务地址将出现额外的业务伙伴关系地址（代理BP）。
源BP的地点可以设置未空，代理BP的发货位置默认为N，无法选择，原因不明。
注意：
这个功能，我测试采购订单是不OK的。2017-10-27

参考：发票地址字段的规则代码（AD_Val_Rule_ID=192）：
    C_BPartner.IsSummary='N'  AND
        ( C_BPartner.C_BPartner_ID=@C_BPartner_ID@                    /* 自己本身 */
          OR 'N'='@IsSOTrx@'                                                          /* 如果不是销售事务，所有BP */
          OR EXISTS                                                                           /* 检查BP关系代理 */
            (
              SELECT * 
              FROM C_BP_Relation r 
              WHERE C_BPartner.C_BPartner_ID=r.C_BPartnerRelation_ID         /* 单据业务伙伴的相关代理 */
              AND r.C_BPartner_ID=@C_BPartner_ID@                                      /* 单据业务伙伴 */
              AND r.IsBillTo='Y'                                                                           /* 发票代理业务 */
             )                                                                                                      /* 也不判断isactive，https://idempiere.atlassian.net/browse/IDEMPIERE-3530?jql= */
         )

更多bug：https://sourceforge.net/p/adempiere/bugs/741/ 
更多线索：
1. 源码无法找到“C_BP_Relation_ID”关键代码
2. CalloutOrder.bPartnerBill  (org.adempiere.base.callout\src\org\compiere\model) ，根本没有relation关键字。
3. issue搜索"Relation"无法找到相关报告。

![伙伴关系代理](https://static.oschina.net/uploads/space/2017/1027/140312_tSVB_2720480.png)

查看使用业务伙伴关系字段的位置

```
select 
e.name as win_name,
d.name as tab_name,
c.tablename as table_name,
b.name as col_name,
a.name as val_name,
code
from  AD_Val_Rule a
left join ad_column b on a.ad_val_rule_id=b.ad_val_rule_id
left join ad_table c on c.ad_table_id=b.ad_table_id
left join ad_tab d on d.ad_table_id=c.ad_table_id and d.isreadonly='N'
left join ad_window e on e.ad_window_id=d.ad_window_id
where UPPER(code) ~ 'RELATION' 

结果：2条

```

仓库
---

鲨鱼

产品
---

==概述==
item是更合适的概念，中文最合适的可以叫“东西”，在系统中多从财务角度去理解这个主数据概念。
Product（东西）分为5个类型：产品、费用、资产、服务、资源。
先说横向范围：
产品：第二产业常用的经营/成本对象，物品/产品/商品/零件/物料/库存物品，等之类的常见的库存实物。
服务：服务行业常用的经营/成本对象，以时间或者次数来计量的服务，比如咨询，教育，金融，安装，设计等
资源：租赁行业常用的经营/成本对象，比如不动产、设备、运输工具。
资产：财务角度的重要成本对象。资本化后的不动产、设备等。系统中，特点是资本化（需折旧）。
费用：财务角度的重要成本对象，常见的营业费用，管理费用及财务费用。特点是非资本化（不需折旧）。

费用的设置有点不一样

再说纵向范围：
每个Product

产品类别可以设置不同的会计核算方式（物流策略和计价方式，会计账户），因此从财务角度来对产品进行区分更符合财务管理的需求。

在系统初始化时，建议分别按照5大类设置产品组，分类的思路是符合财务计量要求和内部使用习惯，比如：
产品类：原料、半成品、成品 （按流程核算）/ 材料、商品、包材（按品种核算）/ 材料、成品（按计价特点核算  ）
服务类：售前服务、实施服务、售后服务（按品种核算）
资源类：设备、运输工具、公共设施 （按品种核算）
资产类：建筑物、生产设备、运输工具、办公设备、IT设备 （按品种核算）
费用类：营业费用、管理费用、财务费用 （按品种核算）
费用有点特殊，直接定义“费用类型”就是定义“费用”。产品类别、税种、只能在“费用类型”设置。

注意：不同的管理角度（工程、会计、销售）对同一物品有不同的分类，可以使用其他分类字段来完成。
材料：工业分类
会计：原料、材料、商品、制成品
销售：单品、组合品、订制品、赠品

====
准则4大分法 ，以“公益价值/现值”和“能否确认损益”组合分法。
金融资产（包括交易性金融资产）
持有至到期投资
可供出售金融资产
贷款和应收款项

三只小猪分金融资产
猪农养了A猪B猪C猪。他对A猪很有感情，打算把它当宠物一直养。B猪呢，刚出生不久，年龄还小，猪农对它没有啥感情，想卖嘞它，可是又拿不准时间，于是只能等呗，先看看再说。C猪呢，又肥又壮，猪农打算尽快卖嘞。

A猪是长期股权投资 2
B猪是可供出售金融资产 3
C猪是交易性金融资产 1

作者：底稿工人

链接：https://www.zhihu.com/question/20743344/answer/16386895
====

产品编码原则：（感谢胡言乱语老师）
1. 一料一号一成本。
2. 先架BOM后编码。

一般编码会依物品本身的外观、型号或特性进行编码,一料一号是
大家都认同的原则,但是在某些情况下可能同一个品项会有二个成本:
成本差距过大导致成本会计人员希望能够分别管理二个不同的成本,以
便管理销售利润。 例如台湾厂和大陆厂作同一个产品(十年前台湾制的
成本高很多,但现在可不一定...) 或是因产能不足而部份请他人代工,
便会产生同一产品有不同生产成本。 至于成本差距在多少以内是可视
为同一项产品而进行加权平均?这就真的要问成会人員和会计师…
因此虽然一个品项应该只有一个品号,但是若成本差异过大需要分
别管理时就要考虑编二个品号。 但相对仓管人员是否能配合就成问题,
因为外观可能无法区别 A1 和 A2 的不同,导致扣 A1 的帐却出了 A2 的
货,这就是所谓一料多号的风险。

而为什么要先架 BOM 再建品号呢?因为在制造业中有分三大类：
原物料／半成品／成品。而原物料和成品是一定会存在的自然没有疑问,
但是相同产品却可能因为不同的生产技术或设备而产生不同的半成品
(后面介绍 BOM 之章节会举例说明)。完全用制令控管会有较多半成品,
若全部利用制程管理则可完全没有半成品。 因此要先把 BOM 架阶完
成之后才会知道有多少的半成品品号要建,而每一个半成品都是要经过
一次的成本计算才能得出成本,半成品愈多则计算成本就愈复杂,但相对
成本信息就愈精细,如何取舍就看企业的需求,但千万不要变来变去…

==产品-采购==
此窗口设置供应商的采购信息。先说几个字段。

1. 采购列表价格：关键参数，与采购单位相关
2. 采购订单价格：初始化可输入产品成本
3. 上次采购价格：如题，但未说明单位
4. 上次发票价格：如题，但未说明单位

当创建价格表版本记录时（默认价格表模式），如果不指定价格表基准，系统将拷贝“产品-采购”所记录的供应商价格信息，即列表价格和标准价格引用供应商的采购列表价格；限制价格引用采购订单价格。
测试如下：
如果1+2都有数，列表价格=标准价格=1
如果1有数，2没有数，列表价格=1； 如果3有数，标准价格=3（后续还更新2=3）
如果3没有数，限制价格=1
参考 M_PriceList_Create.java 的doit。

价格表
---

==概述==
ID的价格管理包含价格管理和折扣管理，其中价格表是必要功能和重要资料。其概念有：
1. 三大价格：列表价格、标准价格、限制价格。
2. 产品必须在价格表中设定，才能进行采购/销售业务。
3. 业务伙伴可以设定价格表版本。
4. 多个价格表版本可以相互引用取数，价格记录批量创建。
5. 单据上可以选择需要的价格表。
6. 价格表针对产品，而不针对产品属性。（官方开发中）
注：开发票都需要价格表

设置流程：价格表模式--价格表
默认系统安装后，产生一个Standard价格表模式（无明细），一个standard价格表（含一个版本的价格表）。
在价格表版本中使用“创建价格表”，必须：
1. 【价格表模式】有一条明细记录
2. 【产品】-【采购】必须有一条采购记录
否则流程无法创建。

表：
M_PriceList
M_PriceListVersion
M_ProductPrice
M_ProductPriceVendorBreak
M_DiscountSchema
M_DiscountSchemaBreak
M_DiscountSchemaLine

==价格表模式==
价格表模式定义了价格表之间操作的计算规则，其包括：
1. 汇率类型
2. 产品类型/产品/业务伙伴的维度
3. 列表价格、标准价格、限制价格的取数规则
4. 金额取整规则
5. 计算规则顺序（按大小进行）

其中，生成价格表的三大价格基数的取数来源为
1. 产品成本：产品的当前成本价格（多成本要素时，如何取值，只去材料成本，未测试）
2. 固定价格：价格表直接取模式明细中的设定价格
3. 列表/标准/限制价格：列表/标准取“采购列表价格”，限制取“采购订单价格”（产品-采购页签）

价格表模式设计通常考虑：
1. 期间：每月的产品价格不一样
2. 供应商：每个供应商设定不一样的价格
3. 产品类型：不同产品类型设定不一样的价格
4. 货币：不同币种的价格不一样
5. 属性：品牌、材质、等级、批次（不支持）

==价格表==
价格表为多个价格表版本的合计，其选项有：
1. 价格表用途：是否销售价格
2. 价格限制：是否强制高于限制价格
3. 货币及精度：该精度不影响显示精度，请参考[精度问题@](http://idempiere_guide_fi.mydoc.io?v=${version}&t=178533)
4. 计税方式：价格是否含税

注意！！！
价格表无单位设置，系统默认产品单位为价格表单位，问题来了。
采购单位=包，库存/销售单位=个，这样的单位转换场景太多了，这导致：
1. 


在价格表下新增价格表版本，其选项有：
1. 起效日期：很重要的时间属性，自动到期生效。假如你有3个价格表版本，生效日期分别是1月1日，2月1日，3月1日，时间到了2月1日，2月自动生效，1月和3月无效。The end date of a price list version is the date of the next version (there is no end date in the record)，
2. 价格表模式：价格表版本的计算规则
3. 基准价格表：价格表版本的计算基准，可以为空，也可以版本间价格引用。
创建价格表版本，可以选择基于其他版本，或者留空（使用模式规则），但基于自己将无法创建新纪录。

使用“创建价格表”流程步骤：
1. 新建一个价格表模式明细<重要，默认系统无明细，步骤3无任何输出，且创建无记录，BUG>
2. 添加产品的采购记录，流程将使用当前供应商的2个“采购价格”字段价格作为价格表的计算来源（默认）。
3. 点击创建价格表（删除旧的，插入新纪录）
4. 系统弹出结果菜单。

多货币下的价格表转换实例：
1.  产品-采购：供应商采购价格=1.23，货币美元。
2. 价格表模式明细：即期汇率，价格附加=1.00（没有单位）
3. 汇率：1美元->1.5欧元
4. 价格表：欧元
5. 价格表版本：价格=（1.23+1）*1.5 = 3.35欧元
从上面例子看出，id支持多货币的价格表定义和转换。源币来自供应商价格货币或者其他价格表定义

价格表版本的价格记录，与产品-价格标签属于同表数据，用户可以直接对该记录进行维护操作。
价格表支持带明细删除，无法撤回，可去除”有效“停用价格表。

==参考==
很多供应商价格表  https://groups.google.com/d/msg/idempiere/0MOZcrjtaFo/X2LkR620CwAJ
促销 http://wiki.adempiere.net/Sponsored_Development:_Promotions

计量单位
---

==概述==
实在不好意思写这个，我不懂，可能这个很复杂。我觉得id的单位转换还能烂。

引用 SAP Warehouse Management Guide (April 2001) page 115:
"Supports all related alternative units of measure for processing. For example, if the weight of a particular material is managed in kilograms, the system can make calculations based on the input of weight measures such as grams, ounces, pounds or tons."

Heng Sin说：
Support four types of records in UOM conversions:
1 - tenant product specific conversion - this is the only one already supported
2 - generic conversions - can be defined on system or tenant and apply to all products with that UOM, f.e. gram to pound would apply to all products with UOM gram
3 - exceptions for the generic conversions - we want to enable the possibility to define on tenant an exclusion for a generic conversion allowing to save a specific generic conversion for the product and inactivating the record
4 - when no product selected it shows the default conversions

源码11625，已经提交了[补丁](https://idempiere.atlassian.net/browse/IDEMPIERE-3301)，去官网测试下。

产品的基本单位设置完成后，如果发生成本事务，系统是不允许更改的。所有库存相关单据（盘库、移库、内部使用、成本调整）都默认使用产品的基本单位进行计量和处理，不允许选择单位。

即：你可以按大单位进行采购/销售，但是库存移动只能使用小单位进行计量。

与单位相关的系统配置参数：
ProductUOMConversionRateValidate：产品单位必须是最小单位，乘率必须>0，默认开启。
ProductUOMConversionUOMValidate：使用产品单位作为源单位，默认开启。

单位问题也是一个老大难问题。
在实际业务中，经常发生多次单位换算，这要求物流和资金流的数据必须与单位同时出现，否则会产生歧义。比如在id系统中的产品-采购页签，采购单位是相对于对采购列表价格的，但是“上次采购订单价格”“开票价格”的单位没有提供，则价格比较就没有意义。

关于价格与单位的匹配功能，参考https://idempiere.atlassian.net/browse/IDEMPIERE-533（五年没有通过）

> ###中途避免
> 1. 新建账套
> 2. 新建成本元素
> 3. 调整计价方法
> 4. 修改单据编号
> 5. 修改核算维度
> 6. 修改组织结构
> 7. 修改科目结构

